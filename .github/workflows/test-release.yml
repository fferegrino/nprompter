name: Test Release to Test PyPI

on:
  push:
    tags:
      - '*'
    branches:
      - develop

jobs:
  test-release:
    name: Release to Test PyPI
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Check if tag is from develop branch
      run: |
        TAG_NAME=${GITHUB_REF#refs/tags/}
        BRANCH_NAME=$(git describe --exact-match --tags $TAG_NAME 2>/dev/null && git branch -r --contains $TAG_NAME | grep 'origin/develop' || echo "")
        if [ -z "$BRANCH_NAME" ]; then
          echo "Tag $TAG_NAME was not created from develop branch. Skipping Test PyPI release."
          exit 1
        fi
        echo "Tag $TAG_NAME is from develop branch. Proceeding with Test PyPI release."
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
    - name: Install UV
      uses: astral-sh/setup-uv@v4
      with:
        version: "latest"
    - name: Install dependencies
      run: uv sync --dev
    - name: Run Flake8
      run: uv run pflake8 .
    - name: Run iSort
      run: uv run isort . --check-only
    - name: Run Black
      run: uv run black . --check
    - name: Run tests
      run: uv run pytest
    - name: Build and publish to Test PyPI
      env:
        TEST_PYPI_PASSWORD: ${{ secrets.TEST_PYPI_PASSWORD }}
      run: |
        uv build
        uv publish --index https://test.pypi.org/simple/ --token ${TEST_PYPI_PASSWORD}
